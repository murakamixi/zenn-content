---
title: "PyCaretã§Anomaly Detection - ç•°å¸¸æ¤œçŸ¥ã‚„ã£ã¦ã¿ã‚‹"
emoji: "ğŸ“‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: true
---

ã€€PyCaretã§ç•°å¸¸æ¤œçŸ¥ã«é–¢é€£ã™ã‚‹è¤‡æ•°ã®ãƒ¢ãƒ‡ãƒ«ã‚’è©¦ã™ã“ã¨ãŒã§ãã¾ã™ã€‚
ã€€ã‚„ã‚Šæ–¹ã®æ—¥æœ¬èªè¨˜äº‹ãŒã‚ã¾ã‚Šãªã‹ã£ãŸã®ã§ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ³å…ˆã§è§¦ã‚‹æ©Ÿä¼šãŒã‚ã£ãŸã®ã§ã€PyCaretã§ã®ç•°å¸¸æ¤œçŸ¥ã®å®Ÿè£…æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚


# è§£æ±ºã—ãŸã„èª²é¡Œã€ç‹™ã†ã‚‚ã®
- ç•°å¸¸æ¤œçŸ¥ã¨ã¯ä½•ã‹ã®èª¬æ˜
- PyCaretã§ã®ç•°å¸¸æ¤œçŸ¥ã®å®Ÿè£…æ–¹æ³•
- PyCaretã«å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ç•°å¸¸æ¤œçŸ¥ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®ç°¡å˜ãªç´¹ä»‹

# ç•°å¸¸æ¤œçŸ¥ã¨ã¯
ã€€ç•°å¸¸æ¤œçŸ¥ã¨ã¯ã€æ­£è§£ãƒ©ãƒ™ãƒ«ãŒåœ§å€’çš„ã«å°‘ãªã„å ´åˆã§ã€ä¸æ­£è§£ã®ãƒ©ãƒ™ãƒ«ãŒã‹ãªã‚Šç‰¹å¾´çš„ãªé›†åˆã‚’å½¢æˆã—ã¦ã„ã‚‹ã¨ãã«ä½¿ãˆã‚‹æ‰‹æ³•ã§ã™ã€‚
ã€€å…·ä½“çš„ã«ã¯å‘ä¸Šã®å·¥ä½œæ©Ÿæ¢°ã®æ•…éšœã®å‰å…†ãªã©ã®æ¤œçŸ¥ã«ç”¨ã„ã‚‰ã‚ŒãŸã‚Šã™ã‚‹ã‚ˆã†ã§ã™ã€‚å·¥å ´ã®å·¥ä½œæ©Ÿæ¢°ã¯ç¨¼åƒæ™‚é–“ã«æ¯”ã¹æ•…éšœã™ã‚‹å‰²åˆã¯æ¥µã‚ã¦å°‘ãªã„ã§ã™ã€‚ãã®ãŸã‚ã€ãã®ã‚ˆã†ãªå·¥å ´ã®å·¥ä½œæ©Ÿæ¢°ã®ãƒ‡ãƒ¼ã‚¿ã¯æ­£å¸¸ãªãƒ‡ãƒ¼ã‚¿ãŒã»ã¨ã‚“ã©ã§ç•°å¸¸ãªæ­£è§£ãƒ©ãƒ™ãƒ«ã‚’å–å¾—ã™ã‚‹ã“ã¨è‡ªä½“ãŒé›£ã—ãã€ãã®ã‚ˆã†ãªå ´åˆã«ç”¨ã„ã‚‰ã‚Œã‚‹æ‰‹æ³•ãŒç•°å¸¸æ¤œçŸ¥ã§ã™ã€‚
ã€€ä»–ã«ã¯ã€éŠ€è¡Œã®ä¸æ­£å–å¼•ã®ç›£è¦–ã‚„ã€åŒ»ç™‚äº‹æ•…ã€ãƒ†ã‚­ã‚¹ãƒˆã®èª¤ã‚Šãªã©ã®æ¤œçŸ¥ã«ã‚‚ä½¿ã‚ã‚Œã¾ã™ã€‚

ã€€æ·±å±¤å­¦ç¿’ã§ã¯ã€AnoGanãªã©ãŒç•°å¸¸æ¤œçŸ¥ã§ã¯æœ‰åã§ã™ã€‚

# PyCaretã«ãŠã‘ã‚‹ç•°å¸¸æ¤œçŸ¥
ã€€PyCaretã®ç•°å¸¸æ¤œçŸ¥ã¯æ•™å¸«ãªã—å­¦ç¿’ãŒãƒ¡ã‚¤ãƒ³ã®ã‚ˆã†ã§ã™ã€‚
ã€€ãŸã ã€å…¬å¼ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã«ã¯PyCaretã®ç•°å¸¸æ¤œçŸ¥ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯åˆ†é¡ã®AUCã‚„å›å¸°ã®R2(æ±ºå®šä¿‚æ•°)ã®ã‚ˆã†ãªæ•™ç†ã‚ã‚Šå­¦ç¿’ã®ç›®çš„ã‚’æœ€é©åŒ–ã™ã‚‹ãŸã‚ã«ã€ç•°å¸¸æ¤œçŸ¥ãƒ¢ãƒ‡ãƒ«ã®ãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’èª¿æ•´ã§ãã‚‹ç‹¬è‡ªé–¢æ•°ã§ã‚ã‚‹```tune_model()```ã‚‚å®Ÿè£…ã—ã¦ã„ã‚‹ã¨ã®ã“ã¨ã§ã™ã€‚
ã€€
> PyCaret's anomaly detection module also implements a unique function tune_model() that allows you to tune the hyperparameters of anomaly detection model to optimize the supervised learning objective such as AUC for classification or R2 for regression.

# ä»Šå›ä½¿ç”¨ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆ

ã€€PyCaretã«åŒå°ã•ã‚Œã¦ã„ã‚‹UCI ã® Mice Protein Expression ã¨ã„ã†ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
ã€€ã“ã‚Œã¯ã€å¤§è„³çš®è³ªã®ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã«é–¢ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚‰ã—ã„ã§ã™ã€‚77å€‹ã®ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã‹ã‚‰å½¢æˆã•ã‚Œã¦ã„ã¦ã€ãã‚Œãã‚Œã®ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã«é–¢ã—ã¦1,080ã®æ¸¬å®šå€¤ãŒå«ã¾ã‚Œã‚‹ã‚ˆã†ã§ã™ã€‚

# ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®å–å¾—
ã€€
ã€€ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã¯PyCaretã«å…¥ã£ã¦ã„ã‚‹ã®ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ç°¡å˜ã«å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

```
from pycaret.datasets import get_data
dataset = get_data('mice')
dataset.shape

# (1080, 82)
```

# ãƒ‡ãƒ¼ã‚¿ã®åˆ†å‰²
ã€€ã“ã“ãŒã‚ã‚‹æ„å‘³æ··åŒã—ã‚„ã™ã„ã®ã§ã™ãŒã€ãƒ‡ãƒ¼ã‚¿ã®åˆ†å‰²ã¯train/evalã®åˆ†å‰²ã§ã¯ãªãã¦testã®åˆ†å‰²ã§ã€å­¦ç¿’æ™‚ã«ã¯ä¸€åˆ‡ä½¿ç”¨ã®ã§ããªã„ãƒ‡ãƒ¼ã‚¿ã«ãªã‚Šã¾ã™ã€‚ã“ã“ã§ã¯ã€ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã«å¾“ã£ã¦5%ã ã‘åˆ‡ã‚Šå–ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

```
data = dataset.sample(frac=0.95, random_state=786)
data_unseen = dataset.drop(data.index)

data.reset_index(drop=True, inplace=True)
data_unseen.reset_index(drop=True, inplace=True)

print('Data for Modeling: ' + str(data.shape))
print('Unseen Data For Predictions: ' + str(data_unseen.shape))

# Data for Modeling: (1026, 82)
# Unseen Data For Predictions: (54, 82)
```


# PyCaretç’°å¢ƒã§å‰å‡¦ç†
ã€€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§å‰å‡¦ç†ã‚’ã—ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿å‹ã‚’ã‚ã‚‰ã‹ãŸæ±ºã‚ã¦ãã‚Œã¾ã™ã€‚ä»Šå›ã¯ãã®ã¾ã¾é€²ã‚“ã§å¤§ä¸ˆå¤«ã§ã™ãŒã€å®Ÿå‹™ã§è§¦ã£ã¦ã„ã‚‹ã¨ãã«ã‚«ãƒ†ã‚´ãƒªå¤‰æ•°ã¨æ•°å€¤å‹ã‚’é–“é•ã£ã¦ã‚‹ã“ã¨ãŒã‚ã£ãŸã®ã§ã€ä¸€å¿œã¡ã‚ƒã‚“ã¨è¦‹ãŸæ–¹ãŒã„ã„ã¨æ€ã„ã¾ã™ã€‚
ã€€
```
from pycaret.anomaly import *

exp_ano101 = setup(data, normalize = True, 
                   ignore_features = ['MouseID'],
                   session_id = 123)
```
ã€€Enterã‚’æŠ¼ã—ã¦å…ˆã«é€²ã¿ã¾ã™ã€‚

### å‡ºåŠ›
|index|Description|Value|
|---|---|---|
|0|session\_id|123|
|1|Original Data|1026,82|
|2|Missing Values|true|
|3|Numeric Features|77|
|4|Categorical Features|4|
|5|Ordinal Features|false|
|6|High Cardinality Features|false|
|7|High Cardinality Method||
|8|Transformed Data|1026,91|
|9|CPU Jobs|-1|
|10|Use GPU|false|
|11|Log Experiment|false|
|12|Experiment Name|anomaly-default-name|
|13|USI|4a55|
|14|Imputation Type|simple|
|15|Iterative Imputation Iteration|None|
|16|Numeric Imputer|mean|
|17|Iterative Imputation Numeric Model|None|
|18|Categorical Imputer|mode|
|19|Iterative Imputation Categorical Model|None|
|20|Unknown Categoricals Handling|least\_frequent|
|21|Normalize|true|
|22|Normalize Method|zscore|
|23|Transformation|false|
|24|Transformation Method|None|
|25|PCA|false|
|26|PCA Method|None|
|27|PCA Components|None|
|28|Ignore Low Variance|false|
|29|Combine Rare Levels|false|
|30|Rare Level Threshold|None|
|31|Numeric Binning|false|
|32|Remove Outliers|false|
|33|Outliers Threshold||
|34|Remove Multicollinearity|false|
|35|Multicollinearity Threshold||
|36|Remove Perfect Collinearity|false|
|37|Clustering|false|
|38|Clustering Iteration||
|39|Polynomial Features|false|
|40|Polynomial Degree||
|41|Trignometry Features|false|
|42|Polynomial Threshold||
|43|Group Features|false|
|44|Feature Selection|false|
|45|Feature Selection Method|classic|
|46|Features Selection Threshold||
|47|Feature Interaction|false|
|48|Feature Ratio|false|
|49|Interaction Threshold||

# ãƒ¢ãƒ‡ãƒ«ã®ä½œæˆ
ã€€ãƒ¢ãƒ‡ãƒ«ã‚’ä½œæˆã—ã¦ã¿ã¾ã™ã€‚ã“ã“ãŒã€å›å¸°ã‚„åˆ†é¡ã¨å°‘ã—é•ã†ã®ã§ã€æˆ¸æƒ‘ã†ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ãã“ã¯PyCaretæ§˜ã§éå¸¸ã«ç°¡å˜ã§ã™ã€‚
ã€€åƒ•ã¯æœ€åˆ```compare_models```ãŒAnomaly Detectionã«ã¯ãªã‹ã£ãŸã§ã™ã€‚

ã€€ä»¥ä¸‹ã§ã¯fractionã§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®šã—ã¦ã„ã¾ã™ãŒã€è¨­å®šã—ãªãã¦ã‚‚å¤§ä¸ˆå¤«ã§ã™ã€‚

```
iforest = create_model('iforest')
# ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ã“ã†ã‚„ã£ã¦è¨­å®šã§ãã‚‹
svm = create_model('svm', fraction = 0.025)
```

## ä½¿ãˆã‚‹ãƒ¢ãƒ‡ãƒ«

ã€€ä½¿ãˆã‚‹ãƒ¢ãƒ‡ãƒ«ä¸€è¦§ã¯ã€ä»¥ä¸‹ã®ã¨ã“ã‚ã‹

https://pycaret.readthedocs.io/en/latest/api/anomaly.html#pycaret.anomaly.create_model

```
models()
```
ã§ã¿ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

|ID|Name|Reference|
|---|---|---|
|abod|Angle-base Outlier Detection|pyod\.models.abod.ABOD|
|cluster|Clustering-Based Local Outlier|pyod\.models.cblof.CBLOF|
|cof|Connectivity-Based Local Outlier|pyod\.models.cof.COF|
|iforest|Isolation Forest|pyod\.models.iforest.IForest|
|histogram|Histogram-based Outlier Detection|pyod\.models.hbos.HBOS|
|knn|K-Nearest Neighbors Detector|pyod\.models.knn.KNN|
|lof|Local Outlier Factor|pyod\.models.lof.LOF|
|svm|One-class SVM detector|pyod\.models.ocsvm.OCSVM|
|pca|Principal Component Analysis|pyod\.models.pca.PCA|
|mcd|Minimum Covariance Determinant|pyod\.models.mcd.MCD|
|sod|Subspace Outlier Detection|pyod\.models.sod.SOD|
|sos|Stochastic Outlier Selection|pyod\.models.sos.SOS|

# ä½œæˆã—ãŸãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿åˆ†æã™ã‚‹
ã€€ä½œæˆã—ãŸãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿åˆ†æã‚’ã™ã‚‹ãŸã‚ã«ã¯ã€```assign_model()```ã‚’ä½¿ã„ã¾ã™ã€‚

```
iforest_results = assign_model(iforest)
iforest_results.head()
```

ä¸€ç•ªå³ç«¯ã‹ã‚‰ä¸€å€‹æ‰‹å‰ã«å‰²ã‚ŠæŒ¯ã‚‰ã‚Œã¦ã„ã‚‹AnomalyãŒãƒ©ãƒ™ãƒ«ã§1ãŒç•°å¸¸å€¤ã€0ãŒæ­£å¸¸å€¤ã§ã™ã€‚
ä¸€ç•ªå³ç«¯ã®Anomaly_scoreã¯äºˆæ¸¬ã•ã‚ŒãŸã‚¹ã‚³ã‚¢ã§ã€å¤–ã‚Œå€¤ã«ã¯ã‚ˆã‚Šå¤§ããªå€¤ãŒä»˜ä¸ã•ã‚Œã¾ã™ã€‚

# ãƒ¢ãƒ‡ãƒ«ã®ãƒ—ãƒ­ãƒƒãƒˆ

ã€€ä»¥ä¸‹ã§t-SNEã§æ¬¡å…ƒåœ§ç¸®ã—ã¦ãƒ—ãƒ­ãƒƒãƒˆã—ã¾ã™ã€‚
ã€€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãŒt-SNEã®ã‚ˆã†ã§ã€UMAPã‚‚ä½¿ãˆã‚‹ã¿ãŸã„ã§ã™ã€‚

https://pycaret.readthedocs.io/en/latest/api/anomaly.html#pycaret.anomaly.plot_model


```
plot_model(iforest)
```

![](https://storage.googleapis.com/zenn-user-upload/654fb37f9e87-20220221.png)


# æœªçŸ¥ã®ãƒ‡ãƒ¼ã‚¿ã§äºˆæ¸¬

ã€€predict_model() é–¢æ•°ã¯ã€æ–°ã—ã„æœªè¦‹ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã«ç•°å¸¸ãƒ©ãƒ™ãƒ«ã‚’å‰²ã‚Šå½“ã¦ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚iforest ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã£ã¦ data_unseen ã«æ ¼ç´ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’äºˆæ¸¬ã—ã¾ã™ã€‚PyCaretã«å…¬é–‹ã•ã‚Œã¦ã„ãªã‹ã£ãŸ54å€‹ã®æ–°ã—ã„ã‚µãƒ³ãƒ—ãƒ«ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

```
unseen_predictions = predict_model(iforest, data=data_unseen)
unseen_predictions.head()
```

# modelã®ã‚»ãƒ¼ãƒ–ã¨ãƒ­ãƒ¼ãƒ‰

ãƒ¢ãƒ‡ãƒ«ã®ã‚»ãƒ¼ãƒ–ã¯ä»¥ä¸‹ã§ã§ãã¾ã™ã€‚

```
save_model(iforest,'Final IForest Model 25Nov2020')
```

ãƒ¢ãƒ‡ãƒ«ã®ãƒ­ãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã§ã§ãã¾ã™ã€‚

```
saved_iforest = load_model('Final IForest Model 25Nov2020')
new_prediction = predict_model(saved_iforest, data=data_unseen)
new_prediction.head()
```
